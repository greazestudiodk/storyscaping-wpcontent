<?php
// get db settings
$getSettings = $this->settings->get();

$check = $this->settings->isPremium();

// extract into vars
if ($check) {
    $settingsArr = $getSettings["settings"];
} else {
    $settingsArr = array(
        "auto_update" => 0,
        "notify_all" => 0,
        "notify_admin" => 0,
        "custom_emails" => [],
        "email_type" => array(
            "email_detect" => 0,
            "email_fixed" => 0,
        )
    );
}
extract($settingsArr);

// call notices
$notices = new OCVMNotifications();
$notices->prepareNotifications(1);

// get notices count
$count = is_countable($notices->notices) ? count($notices->notices) : 0;


?>
<div id="ocvm-parent-wrap" class="ocvm_settings_wrap">
    <div class="wrap ocvm-wrap">
        <?php
        if (!$check) {
            onecom_premium_theme_admin_notice();
        }
        ?>
        <div class="inner one_wrap">
            <div class="wrap_inner">
                <div class="onecom_critical__wrap critical" id="critical">
                    <ul class="critical"></ul>
                </div>
                <div class="onecom_head_change">
                    <div class="onecom_head__inner onecom_head_left">
                        <h2 class="onecom_heading"> <?php echo __('Vulnerability Monitor', OC_PLUGIN_DOMAIN) ?>
                            <svg width="37" height="24" viewBox="0 0 37 24" fill="none"
                                 xmlns="http://www.w3.org/2000/svg">
                                <rect x="0.5" y="0.5" width="36" height="23" rx="3.5" fill="white"/>
                                <path d="M12.618 7.6C13.706 7.6 14.562 7.86 15.186 8.38C15.81 8.9 16.122 9.616 16.122 10.528C16.122 11.44 15.81 12.156 15.186 12.676C14.562 13.196 13.706 13.456 12.618 13.456H10.542V16H9.34203V7.6H12.618ZM12.582 12.412C13.342 12.412 13.922 12.252 14.322 11.932C14.722 11.604 14.922 11.136 14.922 10.528C14.922 9.92 14.722 9.456 14.322 9.136C13.922 8.808 13.342 8.644 12.582 8.644H10.542V12.412H12.582ZM18.7155 10.708C18.9155 10.34 19.2115 10.06 19.6035 9.868C19.9955 9.676 20.4715 9.58 21.0315 9.58V10.696C20.9675 10.688 20.8795 10.684 20.7675 10.684C20.1435 10.684 19.6515 10.872 19.2915 11.248C18.9395 11.616 18.7635 12.144 18.7635 12.832V16H17.6115V9.64H18.7155V10.708ZM25.1168 16.072C24.4848 16.072 23.9168 15.932 23.4128 15.652C22.9088 15.372 22.5128 14.988 22.2248 14.5C21.9448 14.004 21.8048 13.444 21.8048 12.82C21.8048 12.196 21.9448 11.64 22.2248 11.152C22.5128 10.656 22.9088 10.272 23.4128 10C23.9168 9.72 24.4848 9.58 25.1168 9.58C25.7488 9.58 26.3128 9.72 26.8088 10C27.3128 10.272 27.7048 10.656 27.9848 11.152C28.2728 11.64 28.4168 12.196 28.4168 12.82C28.4168 13.444 28.2728 14.004 27.9848 14.5C27.7048 14.988 27.3128 15.372 26.8088 15.652C26.3128 15.932 25.7488 16.072 25.1168 16.072ZM25.1168 15.064C25.5248 15.064 25.8888 14.972 26.2088 14.788C26.5368 14.596 26.7928 14.332 26.9768 13.996C27.1608 13.652 27.2528 13.26 27.2528 12.82C27.2528 12.38 27.1608 11.992 26.9768 11.656C26.7928 11.312 26.5368 11.048 26.2088 10.864C25.8888 10.68 25.5248 10.588 25.1168 10.588C24.7088 10.588 24.3408 10.68 24.0128 10.864C23.6928 11.048 23.4368 11.312 23.2448 11.656C23.0608 11.992 22.9688 12.38 22.9688 12.82C22.9688 13.26 23.0608 13.652 23.2448 13.996C23.4368 14.332 23.6928 14.596 24.0128 14.788C24.3408 14.972 24.7088 15.064 25.1168 15.064Z"
                                      fill="#0078C8"/>
                                <rect x="0.5" y="0.5" width="36" height="23" rx="3.5" stroke="#0078C8"/>
                            </svg>
                        </h2>
                        <p class="onecom_description"> <?php echo __('Get notified when we detect any unsecure plugin, theme, or WordPress version, and act before your website gets compromised.', OC_PLUGIN_DOMAIN) ?></p>
                    </div>
                </div>
            </div>
            <div id="settingsUpdated"></div>
                <div class="onecom_body">
                    <div class="h-parent-wrap">
                    <div class="h-parent">
                        <div class="h-child">
                        <div class="onecom_tabs_container">
                            <div class="onecom_tab active" data-tab="vulnerabilities">
                                <?php echo __('Vulnerabilities', OC_PLUGIN_DOMAIN) ?>
                                <span class="count" id="ocvm_count"
                                    data-count="<?php echo (int)$count; ?>"><?php echo $count; ?></span>
                            </div>
                            <div class="onecom_tab" data-tab="settings">
                                <?php echo __('Settings', OC_PLUGIN_DOMAIN) ?>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
                <form action="#" method="post" id="ocvmForm">
                    <div class="onecom_tabs_panels">
                        <!-- vulnerabilities content start -->
                        <div class="onecom_tabs_panel vulnerabilities" id="vulnerabilities">
                            <?php if($check){ ?>
                            <?php echo $notices->notificationHTML(1); ?>
                            <?php } ?>
                            <!-- Empty placeholder -->
                            <?php if($check){ ?>
                            <div id="no_ocvm_vulneribilityFound" class="<?php echo (0 === $count) ? "" : "hidden" ?>">
                                <div class="innerNoFound">
                                    <img src="<?php echo OCVM_PLUGIN_DIR_URL; ?>/assets/images/no-vm-found.svg"
                                         alt="<?php echo __('Awesome, your website doesn’t have any vulnerabilities!', OC_PLUGIN_DOMAIN); ?>">
                                    <p><?php echo __('Awesome, your website doesn’t have any vulnerabilities!', OC_PLUGIN_DOMAIN); ?></p>
                                </div>
                            </div>
                            <?php } else { ?>
                                <div id="no_ocvm_vulneribilityFound" class="notification-no-Mwp">
                                    <div class="innerNoFound">
                                        <img src="<?php echo OCVM_PLUGIN_DIR_URL; ?>/assets/images/non-Mwp.svg"
                                             alt="<?php echo __('Get access to Vulnerability Monitor and more for free with Managed Wordpress.', OC_PLUGIN_DOMAIN); ?>">
                                        <p><?php echo sprintf(__('Get access to Vulnerability Monitor and more for free with Managed Wordpress.%s %sGet Started%s', OC_PLUGIN_DOMAIN),'<br>','<a href="'.oc_upgrade_link('top_banner').'" target="_blank" style="font-weight:600;">','</a>'); ?></p>
                                    </div>
                                </div>
                            <?php } ?>
                        </div>
                        <!-- vulnerabilities content End -->
                        <!-- Settings content start -->
                        <div class="onecom_tabs_panel settings oc_hidden" id="settings">
                            <div class="cardwrap autoupdatesCard">
                                <div class="fieldset">
                                    <label for="ocvm_autoupdate_enable" class="checkSpinner">
                                <span class="oc_cb_switch ocvmfloatLeft">
                                    <input type="checkbox" class="labelCheck changeUpdate" id="ocvm_autoupdate_enable"
                                           name="ocvm_autoUpdateEnable"
                                           value="<?php echo $auto_update; ?>" <?php if (1 === $auto_update) {
                                        echo 'checked="checked"';
                                    } ?> >
                                    <span class="oc_cb_slider"></span>
                                </span>
                                        <div class="wrap-checkboxtext">
                                            <?php echo __('Vulnerability Monitor auto-update is enabled', OC_PLUGIN_DOMAIN) ?>
                                            <span class="oc_cb_spinner spinner"></span>
                                        </div>
                                    </label>
                                    <p class="oc_desc indentmargin">
                                        <?php echo __('Fix vulnerabilities automatically when we detect any unsecure plugin, theme, or WordPress version.', OC_PLUGIN_DOMAIN) ?>
                                    </p>
                                </div>
                                <div class="field-notes indentmargin">
                                    <strong><?php echo __('Please note:', OC_PLUGIN_DOMAIN); ?></strong>
                                    <ul>
                                        <li><?php echo __('If this setting is enabled, your unsecure plugins will get auto-updated. This means that any custom code will be lost.', OC_PLUGIN_DOMAIN); ?></li>
                                        <li><?php echo sprintf(__('If in any case you want to rollback to a previous version of any of your plugins, please follow the steps in this guide: %sHow to rollback plugin to a previous version?%s', OC_PLUGIN_DOMAIN), '<a href="https://help.one.com/hc/en-us/articles/4402283373841-Roll-back-plugins-and-themes-to-a-previous-version" class="linkset" target="_blank">', '</a>'); ?></li>
                                        <li><?php echo __('Your whole webspace is backed up every 24 hours. In case anything has gone wrong, you have an option to rollback.', OC_PLUGIN_DOMAIN); ?></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="cardwrap emailNotificationCard">
                                <div class="fieldset">
                                    <label for="ocvm_emailnotification_enable" class="checkSpinner">
                                <span class="oc_cb_switch ocvmfloatLeft">
                                    <input type="checkbox" class="labelCheck changeUpdate"
                                           id="ocvm_emailnotification_enable" name="ocvm_EmailNotificationEnable"
                                           value="<?php echo $notify_all; ?>" <?php if (1 === $notify_all) {
                                        echo 'checked="checked"';
                                    } ?> >
                                    <span class="oc_cb_slider"></span>
                                </span>
                                        <div class="wrap-checkboxtext">
                                            <?php echo __('Email notifications are enabled', OC_PLUGIN_DOMAIN) ?>
                                            <span class="oc_cb_spinner spinner"></span>
                                        </div>

                                    </label>
                                    <div class="notifyAdmin indentmargin <?php if (1 !== $notify_all) {
                                        echo "disabledSection";
                                    } ?>">
                                        <label for="ocvm-notifyAdmin"
                                               class="squareCheckbox spacetopBottom checkSpinner">
                                            <input type="checkbox" id="ocvm-notifyAdmin" name="ocvm_notifyAdmin"
                                                   value="<?php echo $notify_admin; ?>"
                                                   class="labelCheck changeUpdate" <?php if (1 === $notify_admin) {
                                                echo 'checked="checked"';
                                            } ?> >
                                            <div class="wrap-checkboxtext">
                                                <?php echo __('Notify administrators', OC_PLUGIN_DOMAIN) ?>
                                                <span class="oc_cb_spinner spinner"></span>
                                            </div>
                                        </label>
                                        <?php if ($check) { ?>
                                            <div class="otherEmail">
                                                <label class="textLabel">
                                                    <?php echo __('Notify others via email', OC_PLUGIN_DOMAIN) ?>
                                                </label>
                                                <div id="ocvm_otherEmailWrap" class="checkSpinner">
                                                <textarea id="ocvm_otherEmail" name="ocvm_otherEmail"
                                                          class="changeUpdate"><?php echo implode(', ', $custom_emails); ?></textarea>
                                                    <span class="oc_cb_spinner spinner"></span>
                                                </div>
                                                <span class="textDesc"
                                                      data-error="<?php echo __('Enter valid Email.', OC_PLUGIN_DOMAIN); ?>"
                                                      data-msg="<?php echo __('Separate emails with comma.', OC_PLUGIN_DOMAIN) ?>"><?php echo __('Separate emails with comma.', OC_PLUGIN_DOMAIN) ?></span>
                                            </div>
                                        <?php } ?>

                                    </div>
                                </div>
                            </div>
                            <div class="cardwrap notifyMeCard <?php if (1 !== $notify_all) {
                                echo "disabledSection";
                            } ?>">
                                <div class="fieldset">
                                    <label for="ocvm_notifyme_when">
                                        <?php echo __('Notify me when', OC_PLUGIN_DOMAIN) ?>
                                    </label>
                                    <label for="ocvm_vmdetectvunerability"
                                           class="squareCheckbox marginbtm checkSpinner">
                                        <input type="checkbox" id="ocvm_vmdetectvunerability"
                                               name="ocvm_vmdetectvunerability"
                                               value="<?php echo $email_type['email_detect']; ?>"
                                               class="labelCheck changeUpdate" <?php if (1 === $email_type['email_detect']) {
                                            echo 'checked="checked"';
                                        } ?> >
                                        <div class="wrap-checkboxtext">
                                            <?php echo __('Vulnerability Monitor detects a vulnerability.', OC_PLUGIN_DOMAIN) ?>
                                            <span class="oc_cb_spinner spinner"></span>
                                        </div>
                                    </label>
                                    <label for="ocvm_vmautofix" class="squareCheckbox checkSpinner">
                                        <input type="checkbox" id="ocvm_vmautofix" name="ocvm_vmautofix"
                                               value="<?php echo $email_type['email_fixed']; ?>"
                                               class="labelCheck changeUpdate" <?php if (1 === $email_type['email_fixed']) {
                                            echo 'checked="checked"';
                                        } ?> >
                                        <div class="wrap-checkboxtext">
                                            <?php echo sprintf(__('Vulnerability Monitor automatically fixes a vulnerability.', OC_PLUGIN_DOMAIN)); ?>
                                            <span class="oc_cb_spinner spinner"></span>
                                        </div>
                                    </label>
                                    <span class="checkboxHelp" style="pointer-events: none !important;">(requires auto-update enabled)</span>
                                </div>
                            </div>
                        </div>
                        <!-- Settings content End -->
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>